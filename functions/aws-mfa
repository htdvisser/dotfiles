mfa_serial=$(aws iam get-user | jq -r '.User.Arn' | sed -e 's|:user/|:mfa/|')
echo "Using MFA device $mfa_serial"

token_code=$1
if [[ -z "$token_code" ]]; then
  token_code=$(ykman oath code $AWS_PROFILE -s)
fi

json=$(aws sts get-session-token --serial-number $mfa_serial --token-code $token_code)

export AWS_ACCESS_KEY_ID=$(echo $json | jq -r .Credentials.AccessKeyId)
export AWS_SECRET_ACCESS_KEY=$(echo $json | jq -r .Credentials.SecretAccessKey)
export AWS_SESSION_TOKEN=$(echo $json | jq -r .Credentials.SessionToken)
