profile=${1:-$AWS_MFA_PROFILE}

mfa_serial=$(AWS_PROFILE="$profile" aws iam get-user | jq -r '.User.Arn' | sed -e 's|:user/|:mfa/|')
echo "Using MFA device $mfa_serial"

token_code=$2
if [[ -z "$token_code" ]]; then
  token_code=$(ykman oath code "$mfa_serial" -s)
fi

json=$(AWS_PROFILE="$profile" aws sts get-session-token --serial-number $mfa_serial --token-code $token_code)

export AWS_ACCESS_KEY_ID=$(echo $json | jq -r .Credentials.AccessKeyId)
export AWS_SECRET_ACCESS_KEY=$(echo $json | jq -r .Credentials.SecretAccessKey)
export AWS_SESSION_TOKEN=$(echo $json | jq -r .Credentials.SessionToken)
